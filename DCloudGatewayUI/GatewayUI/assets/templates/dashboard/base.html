<!DOCTYPE html>
<html lang="zh-tw">
    <head>
        <!--Title-->

        <title>Delta Storage Gateway</title>

        <!--Metadata-->

        <meta http-equiv="Content-type" content="text/html; charset=utf-8" />

        <!--CSS-->
        <link rel="stylesheet" type="text/css" name="bootstrap" href="/static/css/bootstrap.css" />
        <link rel="stylesheet" type="text/css" name="bootstrap" href="
        /static/css/site.css" />
        <link rel="stylesheet/less" type="text/css" href="/static/css/site-dashboard.less">
        {% block stylesheet %}
        {% endblock stylesheet %}
        <style type="text/css">
            {% block css_style %}
            /* Give a quick and non-cross-browser friendly divider */
            {% endblock css_style %}
        </style>
        <script src="/static/js/less-1.3.0.min.js" type="text/javascript"></script>
        <script src="/static/js/jquery-1.7.min.js"></script>
        <script src="/static/js/bootstrap.js"></script>
        <script src="/static/js/jquery-ui-1.8.18.custom.min.js"></script>
        <script src="/static/js/jquery.statusbar.js"></script>
        <script src="/static/js/jquery.validate.min.js"></script>
        <script src="/static/js/hogan.js"></script>
        <script src="/static/js/plugins.js"></script>
        <script type="text/javascript">
            var http_proxy_updating = false;
            $(function(){
                {% if tab %}
                $("#site-tab li:has(a[href='\/dashboard\/{{tab}}\/'])").addClass('active');
                {% else %}
                $("#site-tab li:first").addClass('active');
                {% endif %}
                $('#site-tab li').append('<span></span>');

                function setIndicator(name, status){
                    if (status){
                        $('#'+name).addClass('work');
                    } else {
                        $('#'+name).removeClass('work');
                    }
                }

                // Update the indicator icons
                function update_indicator(){
                    $.get('/dashboard/indicator/', function(ctnt, stat, opts){
                        if (stat == 'success'){
                            var indic;
                            var data = JSON.parse(ctnt);
                            for (indic in data){
                                if (indic == "HTTP_proxy_srv"){
                                    if (!http_proxy_updating){
                                        $("#http_proxy").attr("checked", data[indic]);
                                        if (data[indic]){
                                            $("#http_proxy").addClass("checked");
                                            $("#http_proxy").attr("checked", true)
                                        } else {
                                            $("#http_proxy").removeClass("checked");
                                            $("#http_proxy").attr("checked", false)
                                        }
                                    } else {
                                        continue;
                                    }
                                }
                                if (indic == "uplink_usage"){
                                    $("#basic-bandwidth .up").text(data.uplink_usage);
                                }
                                if (indic == "downlink_usage"){
                                    $("#basic-bandwidth .down").text(data.downlink_usage);
                                }
                                setIndicator(indic, data[indic]);
                            }
                        }
                    });
                }
                setInterval(update_indicator, 1000);
                
                function updateTime(){
                  $.ajax({
                    type:"GET",
                    url:"/dashboard/t",
                    success: function(msg){
                      $(".time_box").text(msg);
                      setInterval(updateTime, 30000);
                    }
                  });
                }
                
                $(function(){
                  updateTime();
                });

                $("body").on('click', ".msg-detail", function(){
                    $(this).toggleClass('active');
                    if ($(this).hasClass('active')){
                        $(this).parent('.msg-content').css('white-space', 'normal');
                    } else {
                        $(this).parent('.msg-content').css('white-space', 'nowrap');
                    }
                });

                $(".tab-btn").on('click', 'li', function(){
                    window.location = $(this).find('a').attr('href');
                })

                var bar = $.statusbar({
                    onClick:function(arg) //add onclick function
                    {
                        alert("Argument= "+arg);
                    }
                });

                var msg_template = Hogan.compile('{% templatetag openvariable %}#msgs{% templatetag closevariable %}<ul class="msg-block"><li class="msg-content error">{% templatetag openvariable %} msg {% templatetag closevariable %}<div class="msg-time">{% templatetag openvariable %} timestamp {% templatetag closevariable %}</div><div class="msg-detail"></div></li></ul>{% templatetag openvariable %}/msgs{% templatetag closevariable %}');

                $.get('/dashboard/syslog/', function(ctnt, success, opt){
                    var msgs = JSON.parse(ctnt);
                    if (msgs == ""){
                        $("#errormsgbox").hide();
                    } else {
                        $(msg_template.render({'msgs': msgs})).appendTo('.statusbar-content');
                    }
                });

                $(".notify-box-row-NW > div").tooltip();
            });
        </script>
        {% block javascript %}
        {% endblock javascript %}
    </head>
    <body>
    <style type='text/css'>
        .time_box {
            margin-left: 100px;
        }
    </style>
    <div class="site-container">
        <div class="site-header">
            <div class="logo-box">
            </div>
            <div class="time_box">
                time
            </div>
            <div class="notify-box-group">
                <div class="notify-box-row-NW">
                    <div id="snapshot_in_progress" rel="tooltip" title="Snapshot In Progress" class="notify-box img-snapshot {% if result_data.snapshot_in_progress %}work{% endif %}">
                    </div>
                    <div id="system_check" rel="tooltip" title="System Check" class="notify-box img-system {% if result_data.system_check %}work{% endif %}">
                    </div>
                    <div id="network_ok" rel="tooltip" title="Network" class="notify-box img-network {% if result_data.network_ok %}work{% endif %}">
                    </div>
                    <div id="flush_inprogress" rel="tooltip" title="Flush In Progress" class="notify-box img-flush {% if result_data.flush_inprogress %}work{% endif %}">
                    </div>
                    <div id="dirtycache_nearfull" rel="tooltip" title="Data not yet protected near full" class="notify-box img-dirtycache {% if result_data.dirtycache_nearfull %}work{% endif %}">
                    </div>
                    <div id="filesystem" rel="tooltip" title="Filesystem has been mounted and running" class="notify-box img-filesystem {% if result_data.dirtycache_nearfull %}work{% endif %}">
                    </div>
                </div>
                <div class="notify-box-row-NE">
                    {{ user.username }}
                </div>
                    <div id="logout_button" class="logout_button notify-box" rel="tooltip" title="Logout">
                        <a href="/logout"><img src="/static/img/dashboard/indicator_logout_icon.png" alt=""></a>
                    </div>
                <div class="notify-box-row-SE">
                    <p id="basic-bandwidth">
                        Download / Upload:<br>
                        <span class="down">{{ result_data.downlink_usage }}</span> / <span class="up">{{ result_data.uplink_usage }}</span>
                        (KB/Sec)
                    </p>
                </div>
            </div><!-- / -->
        </div>

        <div class="left-row left-bg">
            <div>
                <ul class="tab-btn" id="site-tab">
                  <li class=""><a href="{% url dashboard:index %}">Dashboard</a></li>
                  <!--<li class=""><a href="{% url dashboard:account action=None %}">Storage Account</a></li>-->
                  <li class=""><a href="{% url dashboard:system action=None %}">System</a></li>
                  <li class=""><a href="{% url dashboard:config action=None %}">Configuration</a></li>
                  <li class=""><a href="{% url dashboard:sharefolder action=None %}">Shared Folders</a></li>
                  <li class=""><a href="{% url dashboard:sync %}">Sync to Cloud</a></li>
                  <li class=""><a href="{% url dashboard:snapshot action=None %}">Snapshots</a></li>
                  <li class=""><a href="{% url dashboard:syslog %}">System Logs</a></li>
                  <li class=""><a href="{% url dashboard:power action=None %}"><img src="/static/img/dashboard/power_icon.png"></a></li>
                </ul>
            </div>
        </div>

        <div id="errormsgbox"></div>

        <div class="main-row main-bg">
            <div class="main-content">
                <div class="main-content-spacer"></div>
                {% block tab_content %}
                {% endblock tab_content %}
            </div>
        </div>
        <div id="delta-popup">
            <script type="text/javascript">
                $(function(){
                    $("#delta-popup").on("click", ".confirm .button.cancel", function(){
                        $("#delta-popup").fadeOut(1000, function(){
                            $("#delta-popup .popup-box").hide()
                            $("#errormsgbox").show();
                        });
                    });
                    $("#delta-popup").on("click", ".confirm .button.ok", function(){
                    	window.location.assign("{% url dashboard:system_upgrade %}");
                    });
                });
            </script>
            <div class="popup-mask">
            </div>
            <div class="popup-box confirm">
                <p class="warning-h1">Notice</p>
                <p class="warning-h2">The system upgrade will execute.</p>
                <p class="warning-msg">The system will reboot when the update is complete. Please make sure that all your files are saved before the action execute.</p>
                <div class="action-wrap">
                    <div class="button cancel">
                        Cancel
                    </div>
                    <div class="button ok">
                        OK
                    </div>
                </div>
            </div>

            <div class="popup-box notify">
                <script type="text/javascript">
                    $(function(){
                        $("#delta-popup").on("click", ".notify .button.ok", function(){
                            if ($("#check-display input").is(":checked")){
                                $.setCookie('snapshot_create_checkbox', "yes", 365)
                            }
                            $("#delta-popup").fadeOut(1000, function(){
                                $("#delta-popup .popup-box").hide()
                                $("#errormsgbox").show();
                            });
                        });
                    });
                </script>
                <p class="warning-h1">Notice</p>
                <p class="warning-h2">Snapshoting is starting...</p>
                <p class="warning-msg">Snapshoting will complete after all files are stored to the cloud.</p>
                <p id="check-display">
                    <input type="checkbox" name="display" value=""> Don't show it again.
                </p>
                <div class="action-wrap">
                    <div class="button ok">
                        OK
                    </div>
                </div>
            </div>
        </div>
    </div>
    </body>
</html>
