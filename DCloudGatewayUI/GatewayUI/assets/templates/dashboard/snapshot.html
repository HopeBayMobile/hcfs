{% extends "dashboard/base.html" %}
{% block javascript %}
    <script type="text/javascript">

        var toggle_progress_light = (function(target){
            var toogle_indicator = 1;
            function return_func(){
                var num = toogle_indicator % 2 + 1;
                $(target).attr("src", "/static/img/dashboard/in_progress_0" + num + ".png");
                toogle_indicator += 1;
            }
            return return_func
        })("#progress-light");

        var update_schedule;

        $(function(){

            var animate_time = 750;

            setInterval(toggle_progress_light, 500);

            function update_list(){
                $.get("/dashboard/snapshot", function(data){
                    $("#snapshot-list tbody").html(data);
                    if ($($(data)[0]).find('td:nth-child(6)').text() == "Complete"){
                        $("#create").removeClass("disabled")
                    } else {
                        $("#create").addClass("disabled")
                    }
                });
            }

            var $toogle_target;
            function toggle_selector(update_delay){
                if ($toogle_target.hasClass("active")){
                    clearInterval(update_schedule);
                    $("#bottom-popup").animate({"height": "63px"}, animate_time);
                    $(".bottom-popup-spacer").show();
                } else {
                    update_schedule = setInterval(update_list, 1000);
                    $("#bottom-popup").animate({"height": "0px"}, animate_time);
                    $(".bottom-popup-spacer").hide();
                }
                var target_col = $("#" + $toogle_target.text().toLowerCase() + "_chk");
                var chk_box_index = $("th").index(target_col) + 1;
                $("#snapshot-list tr > :nth-child(" + chk_box_index + ")").fadeToggle(animate_time);
                if(update_delay){
                    setTimeout(update_list, update_delay);
                }
            }

            $("body").on("click", ".menu-button.select:not(.disabled)", function(){
                var $me;
                $me = $toogle_target = $(this)
                $("#bottom-popup #do-action").text($me.text());
                $me.toggleClass("active");
                $(".menu-button").not($me).toggleClass("disabled");
                toggle_selector();
            });

            $("body").on("click", "#create:not(.disabled)", function(){
                $(this).addClass("disabled");
                $.post('/dashboard/snapshot/create', function(ctnt){
                    if (!$.getCookie("snapshot_create_checkbox")){
                        $("#errormsgbox").hide()
                        $("#delta-popup .popup-box.notify").show()
                        $("#delta-popup").fadeIn(1000)
                    }
                }).error(function(obj, stat, msg){
                    $("#create-popup").text(obj.responseText).fadeIn(500).delay(2000).fadeOut(500);
                }).complete(function(){
                    setTimeout(update_list, 500);
                });
            });

            $("#bottom-popup #select-cancel").on("click", function(){
                $(".menu-button").removeClass("active disabled")
                toggle_selector(animate_time);
            });

            function get_snapshots(){
                var snapshots = [];
                $.each($(":checked"), function(idx, item){
                    snapshots.push(this.value);
                });
                return snapshots;
            }

            $("#bottom-popup #do-action").on("click", function(){
                $(".menu-button").removeClass("active disabled")
                $.post('/dashboard/snapshot/'+ $(this).text().toLowerCase(),
                       {"snapshots": get_snapshots()},
                       function(ctnt, success, opts){
                           console.log(ctnt);
                       }
                ).complete(function(){
                    toggle_selector(animate_time);
                });
            });

            update_schedule = setInterval(update_list, 1000);

        });
    </script>
{% endblock javascript %}
{% block tab_content %}
    <ul class="nav nav-tabs">
        {% if tab == "snapshot" %}
            <li class="active"><a href="#snapshot" data-toggle="tab">Snapshot</a></li>
        {% else %}
            <li class=""><a href="#snapshot" data-toggle="tab">Snapshot</a></li>
        {% endif %}
        {% if tab == "schedule" %}
            <li class="active"><a href="#schedule" data-toggle="tab">Schedule</a></li>
        {% else %}
            <li class=""><a href="#schedule" data-toggle="tab">Schedule</a></li>
        {% endif %}
        {% if tab == "lifecycle" %}
            <li class="active"><a href="#lifecycle" data-toggle="tab">Life Cycle</a></li>
        {% else %}
            <li class=""><a href="#lifecycle" data-toggle="tab">Life Cycle</a></li>
        {% endif %}
    </ul>
    <div class="tab-content">
        {% if tab == "snapshot" %}
            <div class="tab-pane active" id="snapshot" style="">
        {% else %}
            <div class="tab-pane" id="snapshot" style="">
        {% endif %}
            <div id="create-popup" class="hide"></div>
            <button id="create" class="menu-button ">Create</button>
            <button class="menu-button select">Delete</button>
            <button class="menu-button select">Export</button>
            <div id="" style="">
                <table id="snapshot-list" class="table table-striped table-bordered table-condensed">
                    <thead>
                      <tr>
                        <th id="delete_chk" class="span1 hide">#</th>
                        <th id="export_chk" class="span1 hide">#</th>
                        <th class="span2">Snapshot ID</th>
                        <th class="span1">Usage</th>
                        <th class="span2">Time</th>
                        <th style="width: 75px;">Status</th>
                        <th class="span1">Export</th>
                        <th class="span2">Path</th>
                      </tr>
                    </thead>
                    <tbody>
                    {% include "dashboard/snapshot_tbody.html" %}
                    </tbody>
                </table>
            </div>
            <div class="bottom-popup-spacer"></div>
            <div id="bottom-popup">
                <button id="select-cancel">Cancel</button>
                <button id="do-action">Done</button>
            </div>
        </div>
        <style type='text/css'>
            .schedule_button {
                display: block;
                height: 71px;
                width: 66px;
                float: left;
                background: url('/static/img/dashboard/radio_btn_01.png') no-repeat;
                background-position: left 0px;
                text-indent: -99999px;
            }
            .schedule_button:hover {
                background: url('/static/img/dashboard/radio_btn_02.png') no-repeat;
                background-position: left 0px;
            }
            .schedule_sub_div {
                height: 50px;
                margin-left: 40px;
                margin-top: 15px;
                font-size: 23px;
            }
            .schedule_sub_font_div {
                padding-top: 3px;
                text-indent: 10px;
            }
            .radio_button_div {
                float: left;
                margin-right: 5px;
            }
            .search_div {
                margin-top: 5px;
                text-indent: 68px;
                font-size: 23px;
            }
            .search_option_div {
                text-indent: 68px;
                margin-top: 20px;
                font-size: 23px;
            }
            .submit_button_div {
                text-indent: 450px;
                font-size: 23px;
            }
            .submit_button {
                border: none;
                width: 147px;
                height: 47px;
                background:url(/static/img/wizard/wizard_button.png) no-repeat;
            }
            .button_text {
                font-size: 23px;
                color: white;
            }
            .days_div {
                margin-top: 50px;
                font-size: 23px;
            }
        </style>
        {% if tab == "schedule" %}
            <div class="tab-pane active" id="schedule">
        {% else %}
            <div class="tab-pane" id="schedule">
        {% endif %}
            <form action="/dashboard/snapshot/schedule" method="POST">
            {% csrf_token %}
            <div class="schedule_sub_div">
                <div class="radio_button_div">
                    {% if snapshot_time < 0 %}
                    <input type="radio" name="schedule_radio" value="1" checked>
                    {% else %}
                    <input type="radio" name="schedule_radio" value="1">
                    {% endif %}
                </div>
                <div style="width: 10px;"></div>
                <div class="schedule_sub_font_div">
                    None
                </div>
            </div>
            <div class="schedule_sub_div">
                <div class="radio_button_div">
                    {% if snapshot_time > 0 %}
                    <input type="radio" name="schedule_radio" value="2" checked>
                    {% else %}
                    <input type="radio" name="schedule_radio" value="2">
                    {% endif %}
                </div>
                <div class="schedule_sub_font_div">
                    Snapshot by schedule
                </div>
            </div>
            <div class="search_div">
                Start from:
            </div>
            <div class="search_option_div">
                <select id="select-day" name="select-day">
                {% for key, value in the_day.items %}
                    {% if value == snapshot_time %}
                        <option selected>{{ value }}</option>
                    {% else %}
                        <option>{{ value }}</option>
                    {% endif %}
                {% endfor %}
            </select>
            </div>
            <div class="submit_button_div">
                <button type="submit" value="Modify" class="submit_button" alt="Submit">
                    <div class="button_text">Modify</div>
                </button>
            </div>
            </form>
        </div>
        {% if tab == "lifecycle" %}
            <div class="tab-pane active" id="lifecycle">
        {% else %}
            <div class="tab-pane" id="lifecycle">
        {% endif %}
            <form action="/dashboard/snapshot/lifecycle" method="POST">
            {% csrf_token %}
            <div class="schedule_sub_div">
                SnapShot Life Cycle:<br /><br />
                Snapshots will be Delete after<br />
                <div class="days_div">
                    <input name="days" type="number" min="1" max="365" value="{{ default_day }}" /> days
                </div>
                <div class="submit_button_div">
                    <button type="submit" value="Modify" class="submit_button" alt="Submit">
                        <div class="button_text">Modify</div>
                    </button>
                </div>
            </div>
            </form>
        </div>
    </div>
{% endblock tab_content %}
