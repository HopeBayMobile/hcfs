{% extends "dashboard/base.html" %}
{% block javascript %}
    <script type="text/javascript">

        var toggle_progress_light = (function(target){
            var toogle_indicator = 1;
            function return_func(){
                var num = toogle_indicator % 2 + 1;
                $(target).attr("src", "/static/img/dashboard/in_progress_0" + num + ".png");
                toogle_indicator += 1;
            }
            return return_func
        })("#progress-light");

        $(function(){

            var animate_time = 750;

            setInterval(toggle_progress_light, 500);

            function update_list(){
                $.get("/dashboard/snapshot", function(data){
                    $("#snapshot-list tbody").html(data);
                    if ($($(data)[0]).find('td:nth-child(6)').text() == "Complete"){
                        $("#create").removeClass("disabled")
                    }
                });
            }

            var $toogle_target;
            function toggle_selector(update_delay){
                if ($toogle_target.hasClass("active")){
                    $("#bottom-popup").animate({"height": "63px"}, animate_time);
                    $(".bottom-popup-spacer").show();
                } else {
                    $("#bottom-popup").animate({"height": "0px"}, animate_time);
                    $(".bottom-popup-spacer").hide();
                }
                var target_col = $("#" + $toogle_target.text().toLowerCase() + "_chk");
                var chk_box_index = $("th").index(target_col) + 1;
                $("#snapshot-list tr > :nth-child(" + chk_box_index + ")").fadeToggle(animate_time);
                if(update_delay){
                    setTimeout(update_list, update_delay);
                }
            }

            $("body").on("click", ".menu-button.select:not(.disabled)", function(){
                var $me;
                $me = $toogle_target = $(this)
                $("#bottom-popup #do-action").text($me.text());
                $me.toggleClass("active");
                $(".menu-button").not($me).toggleClass("disabled");
                toggle_selector();
            });

            $("body").on("click", "#create:not(.disabled)", function(){
                $(this).addClass("disabled");
                $.post('/dashboard/snapshot/create', function(ctnt){
                    // Show alert message if necessary
                }).error(function(obj, stat, msg){
                    $("#create-popup").text(obj.responseText).fadeIn(500).delay(2000).fadeOut(500);
                }).complete(function(){
                    update_list();
                });
            });

            $("#bottom-popup #select-cancel").on("click", function(){
                $(".menu-button").removeClass("active disabled")
                toggle_selector(animate_time);
            });

            function get_snapshots(){
                var snapshots = [];
                $.each($(":checked"), function(idx, item){
                    snapshots.push(this.value);
                });
                return snapshots;
            }

            $("#bottom-popup #do-action").on("click", function(){
                $(".menu-button").removeClass("active disabled")
                $.post('/dashboard/snapshot/'+ $(this).text().toLowerCase(),
                       {"snapshots": get_snapshots()},
                       function(ctnt, success, opts){
                           console.log(ctnt);
                       }
                ).complete(function(){
                    toggle_selector(animate_time);
                });
            });

        });
    </script>
{% endblock javascript %}
{% block tab_content %}
    <ul class="nav nav-tabs">
        <li class="active"><a href="#snapshot" data-toggle="tab">Snapshot</a></li>
        <li class=""><a href="#schedule" data-toggle="tab">Schedule</a></li>
    </ul>
    <div class="tab-content">
        <div class="tab-pane active" id="snapshot" style="">
            <div id="create-popup" class="hide"></div>
            <button id="create" class="menu-button ">Create</button>
            <button class="menu-button select">Delete</button>
            <button class="menu-button select">Export</button>
            <div id="" style="">
                <table id="snapshot-list" class="table table-striped table-bordered table-condensed">
                    <thead>
                      <tr>
                        <th id="delete_chk" class="span1 hide">#</th>
                        <th id="export_chk" class="span1 hide">#</th>
                        <th class="span2">Snapshot ID</th>
                        <th class="span1">Usage</th>
                        <th class="span2">Time</th>
                        <th style="width: 75px;">Status</th>
                        <th class="span1">Export</th>
                        <th class="span2">Path</th>
                      </tr>
                    </thead>
                    <tbody>
                    {% include "dashboard/snapshot_tbody.html" %}
                    </tbody>
                </table>
            </div>
            <div class="bottom-popup-spacer"></div>
        </div>
        <div class="tab-pane" id="schedule">
            This is the schedule view.
        </div>
    </div>
    <div id="bottom-popup">
        <button id="select-cancel">Cancel</button>
        <button id="do-action">Done</button>
    </div>
{% endblock tab_content %}
