{% extends "base.html" %}
{% block head_title %}New Account{% endblock %}

{% block body_class %}home{% endblock %}

{% block moreScripts%}
<script src="/static/js/bootstrap-modal.js" type="text/javascript"></script>
<script src="/static/js/jquery.validate.min.js" type="text/javascript"></script>
<script src="/static/js/additional-methods.min.js" type="text/javascript"></script>
<script type="text/javascript">
    $(document).ready(function() {
            $("#form1").validate();
            });
</script>
{% endblock %}

{% block navbar_class %}{% endblock %}
{% block navbar %}
                    <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                                <span class="icon-bar"></span>
                                <span class="icon-bar"></span>
                                <span class="icon-bar"></span>
                            </a>
                            <a class="brand" href="/">Cloud Storage</a>
                            <div class="nav-collapse">
                              <!--ul class="nav">
                                <li><a href="#tab_one">One</a></li>
                                <li><a href="#tab_two">Two</a></li>
                              </ul-->
                              {% block account_bar %}{% include "_account_bar.html" %}{% endblock %}
                            </div>
                    </div>
{% endblock %}
{% block body %}
<div class="container-fluid">
    <div class="row-fluid">
      <div id="sidebar" class="span3">
      {% include "_side_bar.html" %}
    </div>
  <div id="screen" class="span9">
<h2>Edit Account</h2>
<form action="/account/{{account_id}}/update" method="post" id="form1">
    {% csrf_token %}
    <div id="accountDiv" data-role="fieldcontain">
      Account ID: {{account_id}}
      <label for="description">Description:</label><textarea rows="3" name="description" id="description"
          class="required alphanumericSpace" maxLength="128">{{description}}</textarea>
      <label for="submit"></label>
      <input class="btn" type="submit" value="OK" /> <a class="btn" href="/account/">Cancel</a>
    </div>
</form>
  <div class="row-fluid">
    <div class="span7">
<h3>User List under the account "{{account_id}}":</h3>
    </div>
    <div class="span2">
    <a class="btn btn-primary" href="/account/{{account_id}}/user/new">New User</a>
    </div>
  </div>
  <div class="row-fluid">
    <div class="span9">
  <table class="table">
<tr>
<th></th>
<th>User Name</th>
<th>Description</th>
<th></th>
</tr>
{% for user in users %}
<tr>
<td>1</td>
{% if user.user_enable %}
<td><a href="/account/{{account_id}}/user/{{user.id}}/edit">{{user.id}}</a></td>
{% else %}
<td>{{user.id}}</td>
{% endif %}
<td>{{user.description}}</td>
<td>
{% if user.user_enable %}
<a class="btn" id="reset_pw${{user.id}}" name="{{user.id}}">Reset PW</a> <a class="btn" id="query_pw${{user.id}}" name="{{user.id}}">Query</a>
<a class="btn" id="dis_user${{user.id}}" name="{{user.id}}" href="#modal" class="btn" data-toggle="modal" data-target="#disable_user"><i class="icon-off"></i>Off</a>
{% else %}
<a class="btn" disabled="disabled">Reset PW</a> <a class="btn" disabled="disabled">Query</a>
<a class="btn" href="/account/{{account_id}}/user/{{user.id}}/enable"><i class="icon-off"></i>On</a></a>
{% endif %}
</td>
</tr>
{% endfor%}
<!--tr>
<td>1</td>
<td><a href="/account/{{account_id}}/user/Admin/edit">Admin</a></td>
<td>I'm Administrator...</td>
<td><a class="btn" id="reset_pw$Admin">Reset PW</a> <a class="btn" id="query_pw$Admin">Query</a>
<a class="btn" id="dis_user$Admin" href="#modal" class="btn" data-toggle="modal" data-target="#disable_user"><i class="icon-off"></i>Off</a></td>
</tr>
<tr>
<td>2</td>
<td><a href="/account/{{account_id}}/user/User1/edit">User1</a></td>
<td>I'm ghost</td>
<td><a class="btn" id="reset_pw$Yoo">Reset PW</a> <a class="btn" id="query_pw$User1">Query</a> <a class="btn" href="/account/user/User1/enable"><i class="icon-off"></i>On</a></a></td>
</tr>
<tr>
<td>1</td>
<td><a href="/account/{{account_id}}/user/Yooedit">Yoo</a></td>
<td>lala...</td>
<td><a class="btn" id="reset_pw$Yoo">Reset PW</a> <a class="btn" id="query_pw$Yoo">Query</a> <a class="btn" id="dis_user$Yoo" href="#modal" class="btn" data-toggle="modal" data-target="#disable_user"><i class="icon-off"></i>Off</a></a></td>
</tr-->
  </table>
  </div>
  </div>
</div>

<div class="modal hide" id="disable_user">
  <div class="modal-header">
    <a class="close" data-dismiss="modal">×</a>
    <h3>Attention!</h3>
  </div>
  <div class="modal-body">
    This will suspend user "<span id="modal_dis_user"></span>" service, are you sure?
  </div>
  <div class="modal-footer">
    <span class="btn btn-primary" id="modal_dis_user_link">Yes</span>
    <a href="#" class="btn" data-dismiss="modal">No</a>
  </div>
</div>

<div class="modal hide" id="query_user_password">
  <div class="modal-header">
    <a class="close" data-dismiss="modal">×</a>
    <h3>Query Password</h3>
  </div>
  <div class="modal-body">
    User "<span id="modal_pw_user"></span>" Password is "<span id="modal_pw"></span>"
  </div>
  <div class="modal-footer">
    <a href="#" class="btn" data-dismiss="modal">Close</a>
  </div>
</div>

<div class="modal hide" id="reset_user_password">
  <div class="modal-header">
    <a class="close" data-dismiss="modal">×</a>
    <h3>Reset Password</h3>
  </div>
  <div class="modal-body">
    <label for="oldpassword">Please enter old password "<span id="modal_oldpw"></span>"</label>
    <input type="text" name="oldpassword" id="oldpassword" class="required" minlength="3"/>
    <span id="notmatch" class="hide label label-important">words not match</span>
    </div>
  <div class="modal-footer">
   <a class="btn" id="reset_password">OK</a> <a href="#" class="btn" data-dismiss="modal">Cancel</a>
  </div>
</div>

<div class="modal hide" id="reset_password_successful">
  <div class="modal-header">
    <a class="close" data-dismiss="modal">×</a>
    <h3>Reset Password Successful</h3>
  </div>
  <div class="modal-body">
    New password is: "<span id="modal_reset"></span>"
    </div>
  <div class="modal-footer">
    <a href="#" class="btn" data-dismiss="modal">Close</a>
  </div>
</div>

  <script type="text/javascript">
   var user_id;
   var user_pw;
   $('a[id*="dis_user"]').click(function(evt){
    $('#modal_dis_user').html(this.name);
    user_id = this.name;
    $('#modal_dis_user_link').click(function(){
        //$('#disable_user').modal('hide');
    	window.location = "/account/{{account_id}}/user/"+user_id+"/disable";
    });
    $('#disable_user').modal('show');
    //$('#modal_dis_user_link').attr("href","/account/{{account_id}}/user/"+this.name+"/disable");
  });
   
   $('a[id*="query_pw"]').click(function(evt){
    $('#modal_pw_user').html(this.name);
    user_id = this.name;
    //use ajax to query password
    $.ajax({
        type:"GET",
        url:"/account/{{account_id}}/user/"+user_id+"/password",
        success: function(msg){
          $("#modal_pw").text(msg);
          $('#query_user_password').modal('show');
        }
    });
  });
  
  $('a[id*="reset_pw"]').click(function(evt){
    user_id = this.name;
    //use ajax to query password
    $.ajax({
        type:"GET",
        url:"/account/{{account_id}}/user/"+user_id+"/password",
        success: function(msg){
          user_pw = msg;
          $("#modal_oldpw").text(msg);
          $('#reset_user_password').modal('show');
        }
    });
    $('#reset_user_password').modal('show');
  });
  
  $('#reset_password').click(function(evt){
    //check old password, query new
    console.log($("#oldpassword").val()+":"+user_pw);
    if(user_pw===$("#oldpassword").val()){
      $('#reset_user_password').modal('hide');
      $.ajax({
        type:"GET",
        url:"/account/{{account_id}}/user/"+user_id+"/password/reset",
        success: function(msg){
          $("#modal_reset").text(msg);
          $('#reset_password_successful').modal('show');
        }
      });
    } else {
      //alert("words not match");
      $("#oldpassword").val("");
      $("#notmatch").removeClass("hide");
    }
  });
  </script>
{% endblock %}
