# A sample Makefile for building Google Test and using it in user
# tests.  Please tweak it to suit your environment and project.  You
# may want to move it to your project's root directory.
#
# SYNOPSIS:
#
#   make [all]  - makes everything.
#   make TARGET - makes the given target.
#   make clean  - removes all files generated by make.

# Please tweak the following variable definitions as needed by your
# project, except GTEST_HEADERS, which you can use in your own targets
# but shouldn't modify.
include ../common.mk

# All tests produced by this Makefile.

define ADDTEST
$(eval T := $(strip $1))
$(eval OBJS := $(addprefix $(OBJ_DIR)/, $2))
TESTS += $(T)
RUN_TESTS += run-$(T)
-include $(OBJS:%.o=%.d) # Load dependency info for *existing* .o files

$(T): $(OBJS) $(OBJ_DIR)/gtest_main.a
	$(CXX) $(CPPFLAGS) $(CXXFLAGS) -g $$^ -o $$@ -lstdc++ -lpthread

run-$(T): $(T)
	./$$< --gtest_output=xml:test_detail_$$<.xml
.PHONY: run-$(T)
endef

# monitor unittest
$(eval $(call ADDTEST, \
  pyhcfs_unittest, \
  pyhcfs_unittest.o))

test: $(RUN_TESTS)
ifndef NOGCOVR
	gcovr -p -k -r $(USER_DIR) .
endif

clean:
	rm -rf $(TESTS) *.gcda *.gcov $(OBJ_DIR) *.xml

# finalizing the default targets
all: setup $(TESTS)
