# A sample Makefile for building Google Test and using it in user
# tests.  Please tweak it to suit your environment and project.  You
# may want to move it to your project's root directory.
#
# SYNOPSIS:
#
#   make [all]  - makes everything.
#   make TARGET - makes the given target.
#   make clean  - removes all files generated by make.

# Please tweak the following variable definitions as needed by your
# project, except GTEST_HEADERS, which you can use in your own targets
# but shouldn't modify.
include ../common.mk

# All tests produced by this Makefile.

define ADDTEST
TESTS += $1
$(eval NEW_OBJS := $(addprefix $(OBJ_DIR)/, $2))
$(eval OBJS += $(NEW_OBJS))
$1: $(NEW_OBJS) $(OBJ_DIR)/gtest_main.a
	$(CXX) $(CPPFLAGS) $(CXXFLAGS) -g $$^ -o $$@ -lstdc++ -lpthread
endef

# monitor unittest
$(eval $(call ADDTEST, monitor_unittest, \
	monitor.o monitor_unittest.o monitor_mock_function.o))

clean :
	rm -rf $(TESTS) *.gcda *.gcov $(OBJ_DIR)/*

.PHONY : setup
setup :
	@$(USER_DIR)/../../utils/setup_dev_env.sh -m unit_test

RUN_TESTS := $(TESTS:%=test-%)
.PHONY : $(RUN_TESTS)
$(RUN_TESTS) :
	./$(@:test-%=%) --gtest_output=xml:test_detail_$(@:test-%=%).xml

test : all $(RUN_TESTS)
ifndef NOGCOVR
	gcovr -p -k -r $(USER_DIR) .
endif

# finalizing the default targets
all : setup $(TESTS)
